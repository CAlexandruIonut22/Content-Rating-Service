{% extends "base.html" %}

{% block title %}ÃncarcÄƒ conÈ›inut{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3>ÃncarcÄƒ conÈ›inut nou</h3>
            </div>
            <div class="card-body">
                <!-- InformaÈ›ii despre tipurile suportate -->
                <div class="alert alert-info mb-4">
                    <h5>Ce poÈ›i Ã®ncÄƒrca:</h5>
                    <ul class="mb-0">
                        <li><strong>FiÈ™iere:</strong> txt, pdf, doc, mp4, mov, mp3, wav</li>
                        <li><strong>Link-uri web:</strong> articole, bloguri, pagini de È™tiri</li>
                        <li><strong>Text manual:</strong> analizÄƒ directÄƒ cu AI (fÄƒrÄƒ salvare)</li>
                    </ul>
                </div>

                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Titlu</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ request.args.get('title', manual_title or '') }}" required 
                               placeholder="DÄƒ un titlu conÈ›inutului">
                        <div class="form-text">
                            Pentru URL-uri, titlul poate fi extras automat dacÄƒ nu Ã®l completezi.
                        </div>
                    </div>

                    <!-- Tab-uri pentru a alege Ã®ntre fiÈ™ier, URL È™i text manual -->
                    <div class="mb-3">
                        <h5>Alege sursa conÈ›inutului:</h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="source_type" id="source_file" value="file" checked>
                            <label class="btn btn-outline-primary" for="source_file">ÃncarcÄƒ fiÈ™ier</label>
                            
                            <input type="radio" class="btn-check" name="source_type" id="source_url" value="url">
                            <label class="btn btn-outline-primary" for="source_url">Link web</label>
                            
                            <!-- NOU: OpÈ›iunea pentru text manual -->
                            <input type="radio" class="btn-check" name="source_type" id="source_manual" value="manual_text">
                            <label class="btn btn-outline-primary" for="source_manual">ğŸ“ Text manual</label>
                        </div>
                    </div>

                    <!-- SecÈ›iunea pentru fiÈ™iere -->
                    <div id="file-section" class="mb-3">
                        <label for="file" class="form-label">SelecteazÄƒ fiÈ™ier</label>
                        <input type="file" class="form-control" id="file" name="file">
                        <div class="form-text text-muted">
                            <strong>AcceptÄƒm:</strong><br>
                            ğŸ“„ Text: txt, pdf, doc, docx<br>
                            ğŸ¥ Video: mp4, mov, avi<br>
                            ğŸµ Audio: mp3, wav, ogg
                        </div>
                    </div>

                    <!-- SecÈ›iunea pentru URL-uri -->
                    <div id="url-section" class="mb-3" style="display: none;">
                        <label for="url" class="form-label">Link cÄƒtre conÈ›inut</label>
                        <input type="url" class="form-control" id="url" name="url" 
                               value="{{ request.args.get('url', '') }}"
                               placeholder="https://example.com/articol">
                        <div class="form-text text-muted">
                            <strong>FuncÈ›ioneazÄƒ bine cu:</strong><br>
                            ğŸ“° Articole de È™tiri<br>
                            ğŸ“ PostÄƒri de blog<br>
                            ğŸ“– Pagini Wikipedia<br>
                            ğŸ“„ DocumentaÈ›ii online
                        </div>
                        
                        <!-- Buton pentru testarea URL-ului -->
                        <div class="mt-2">
                            <a href="/test-url-extraction" class="btn btn-sm btn-outline-info" target="_blank">
                                ğŸ” TesteazÄƒ mai Ã®ntÃ¢i URL-ul
                            </a>
                        </div>
                    </div>

                    <!-- SecÈ›iunea pentru text manual - NOU -->
                    <div id="manual-section" class="mb-3" style="display: none;">
                        <label for="manual_text" class="form-label">Textul pentru analizÄƒ directÄƒ</label>
                        <textarea class="form-control" id="manual_text" name="manual_text" 
                                  rows="8" placeholder="Introdu aici textul pe care vrei sÄƒ Ã®l analizezi direct...">{{ manual_text or '' }}</textarea>
                        <div class="form-text text-muted">
                            <strong>AnalizÄƒ directÄƒ:</strong><br>
                            ğŸš€ Textul va fi analizat imediat cu TinyLlama<br>
                            ğŸ“Š Vei primi un scor de factualitate instant<br>
                            ğŸ’¾ Nu se salveazÄƒ Ã®n baza de date - doar analizÄƒ<br>
                            <span id="manual-char-count">0</span> caractere
                        </div>
                        
                        <div class="alert alert-info mt-2">
                            â„¹ï¸
                            <strong>DiferenÈ›a:</strong> DacÄƒ alegi "Text manual", textul va fi analizat direct fÄƒrÄƒ sÄƒ fie salvat ca conÈ›inut permanent. 
                            Pentru a salva textul È™i sÄƒ poatÄƒ fi evaluat de alÈ›i utilizatori, Ã®ncarcÄƒ-l ca fiÈ™ier .txt.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="content_type" class="form-label">Tipul conÈ›inutului</label>
                        <select class="form-select" id="content_type" name="content_type">
                            <option value="text">Text (articole, documente)</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">ProceseazÄƒ conÈ›inutul</button>
                        <a href="/" class="btn btn-outline-secondary">AnuleazÄƒ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // LogicÄƒ pentru a schimba Ã®ntre fiÈ™ier, URL È™i text manual
    document.querySelectorAll('input[name="source_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const fileSection = document.getElementById('file-section');
            const urlSection = document.getElementById('url-section');
            const manualSection = document.getElementById('manual-section');
            const fileInput = document.getElementById('file');
            const urlInput = document.getElementById('url');
            const manualInput = document.getElementById('manual_text');
            
            // Ascunde toate secÈ›iunile mai Ã®ntÃ¢i
            fileSection.style.display = 'none';
            urlSection.style.display = 'none';
            manualSection.style.display = 'none';
            
            // EliminÄƒ atributul required de la toate
            fileInput.removeAttribute('required');
            urlInput.removeAttribute('required');
            manualInput.removeAttribute('required');
            
            // GoleÈ™te valorile (doar dacÄƒ nu vin din backend)
            if (!{{ 'true' if manual_text else 'false' }}) {
                fileInput.value = '';
                urlInput.value = '';
                manualInput.value = '';
            }
            
            // AfiÈ™eazÄƒ secÈ›iunea corectÄƒ
            if (this.value === 'file') {
                fileSection.style.display = 'block';
                fileInput.setAttribute('required', '');
            } else if (this.value === 'url') {
                urlSection.style.display = 'block';
                urlInput.setAttribute('required', '');
            } else if (this.value === 'manual_text') {
                manualSection.style.display = 'block';
                manualInput.setAttribute('required', '');
                updateManualCharCount(); // ActualizeazÄƒ contorul
            }
        });
    });
    
    // FuncÈ›ie pentru contorizarea caracterelor Ã®n text manual
    function updateManualCharCount() {
        const text = document.getElementById('manual_text').value;
        const charCount = text.length;
        const counter = document.getElementById('manual-char-count');
        counter.textContent = charCount;
        
        // SchimbÄƒ culoarea dacÄƒ devine prea lung
        if (charCount > 2000) {
            counter.style.color = 'orange';
            counter.title = 'Text lung - doar Ã®nceputul va fi analizat';
        } else {
            counter.style.color = '';
            counter.title = '';
        }
    }
    
    // AdaugÄƒ event listener pentru contorizarea caracterelor
    document.getElementById('manual_text').addEventListener('input', updateManualCharCount);
    
    // IniÈ›ializez corect dacÄƒ vine cu URL din query params
    {% if request.args.get('url') %}
        document.getElementById('source_url').checked = true;
        document.getElementById('source_url').dispatchEvent(new Event('change'));
    {% endif %}
    
    // IniÈ›ializez corect dacÄƒ vine cu text manual din backend
    {% if manual_text %}
        document.getElementById('source_manual').checked = true;
        document.getElementById('source_manual').dispatchEvent(new Event('change'));
    {% endif %}
    
    // Actualizare automatÄƒ tip conÈ›inut bazat pe extensia fiÈ™ierului
    document.getElementById('file').addEventListener('change', function() {
        const fileName = this.value.toLowerCase();
        const contentTypeSelect = document.getElementById('content_type');
        
        if (fileName.includes('.mp4') || fileName.includes('.mov') || fileName.includes('.avi')) {
            contentTypeSelect.value = 'video';
        } else if (fileName.includes('.mp3') || fileName.includes('.wav') || fileName.includes('.ogg')) {
            contentTypeSelect.value = 'audio';
        } else {
            contentTypeSelect.value = 'text';
        }
    });
</script>
{% endblock %}